var auth={id:null,email:null};function onSignIn(t){$("#commentInsertForm").show(),$("#googleSigninButton").hide();var e=t.getBasicProfile();auth.id=e.getId(),auth.email=e.getEmail(),getCommentList()}function onFailure(t){console.log(t)}function onLoad(){gapi.load("auth2,signin2",function(){var e=gapi.auth2.init();e.then(function(){var t=e.isSignedIn.get();e.currentUser.get();gapi.signin2.render("googleSigninButton",{onsuccess:"onSignIn",onfailure:"onFailure",longtitle:!0,theme:"dark",width:"0"}),t?($("#commentInsertForm").show(),$("#googleSigninButton").hide()):($("#commentInsertForm").hide(),$("#googleSigninButton").show(),getCommentList())})})}function commentAjax(t,e,n,i){$.ajax({url:"http://nowonbun.woobi.co.kr"+t,type:"POST",dataType:"json",data:e,success:function(t,e,a){i.call(this,t),n&&getCommentList()},error:function(t,e,a){console.log(t),$("#commentSystem").css("text-align","center"),$("#commentSystem").html("<img src='/img/image_fix.png' style='height: 40px'>"),toastr.success("시스템 에러입니다.")},complete:function(t,e){}})}function checkLogin(){return""===$.trim(auth.id)?(toastr.error("로그인 해주시기 바랍니다."),!1):""!==$.trim(auth.email)||(toastr.error("로그인 해주시기 바랍니다."),!1)}function getCommentList(){commentAjax("/select.php","url="+location.origin+location.pathname+"&id="+auth.id+"&email="+auth.email,!1,function(t){$("#commentList").html("");var m=$("#commentList");function c(t,e,a,n,i,o,m){var c=$("<div></div>").addClass("comment-item");m&&c.addClass("comment-reply"),c.append($("<input type='hidden'>").addClass("comment-idx").val(t));var r=$("<div></div>").addClass("comment-header");return $area=$("<div class='command-item-panel'></div>"),m&&$area.append($("<i class='fa fa-mail-reply'></i>")),"admin"==e&&(e="주인장"),$area.append($("<span></span>").text("작성자: "+e)),$area.append($("<span></span>").text("작성일: "+a)),$area.append($("<span></span>").text("수정일: "+n)),r.append($area),c.append(r),c.append($("<div></div>").addClass("comment-box").text(i)),$area=$("<div style='text-align:right' class='command-item-panel'></div>"),o&&($area.append($("<span><a href='javascript:void(0);' class='comment-modify' data-idx='"+t+"'>수정</a></span>")),$area.append($("<span><a href='javascript:void(0);' class='comment-delete' data-idx='"+t+"'>삭제</a></span>"))),m||""===$.trim(auth.id)||""===$.trim(auth.email)||$area.append($("<span><a href='javascript:void(0);' class='comment-re' data-idx='"+t+"'>리플달기</a></span>")),c.append($area),c}!function t(e,a){for(var n=0;n<e.length;n++){var i=e[n],o=c(i.idx,i.email,i.createdate,i.lastupdated,i.comment,i.ismodify,a);m.append(o),null!=i.child&&0<i.child.length&&t(i.child,!0)}}(t,!1)})}$(function(){$(document).on("click",".comment-modify",function(){if(checkLogin()){var t=$(this),e=t.parent().parent().parent().find(".comment-box"),a=e.text();e.html(""),e.append("<div style='text-align:right;'><button type='button' class='btn btn-sm btn-outline-success waves-effect modify-btn'>수정하기</button></div>");var n=$("<div></div>").addClass("md-form comment-form");n.append($("<textarea class='form-control md-textarea comment-textarea' maxlength='300' length='300' rows='3'></textarea>").prop("id","commentText"+t.data("idx")).data("idx",t.data("idx")).text(a)),n.append($("<label for='commentText"+t.data("idx")+"' class='comment-textarea-label active'>댓글 수정하기</label>")),e.append(n),t.remove()}}),$(document).on("click",".modify-btn",function(){if(checkLogin()){var t=$(this).parent().parent().parent().find(".comment-box").find(".comment-textarea"),e=t.val().replace("\r\n"," ").replace("\r"," ").replace("\n"," ");""===$.trim(e)&&toastr.error("댓글 내용을 입력해 주시기 바랍니다."),commentAjax("/modify.php","url="+location.origin+location.pathname+"&idx="+t.data("idx")+"&id="+auth.id+"&email="+auth.email+"&comment="+e,!0,function(){toastr.success("수정되었습니다.")})}}),$(document).on("click",".comment-delete",function(){if(checkLogin()){var t=$(this);commentAjax("/delete.php","url="+location.origin+location.pathname+"&idx="+t.data("idx")+"&id="+auth.id+"&email="+auth.email,!0,function(){toastr.success("삭제되었습니다.")})}}),$(document).on("click",".comment-re",function(){if(checkLogin()){var t=$(this),e=$("<div></div>").addClass("comment-box").css("margin-top","10px");t.parent().parent().append(e);var a=t.data("idx");e.append("<div style='text-align:right;'><button type='button' class='btn btn-sm btn-outline-success waves-effect reply-btn' data-idx='"+a+"'>리플 달기</button></div>");var n=$("<div></div>").addClass("md-form comment-form");n.append($("<textarea class='form-control md-textarea comment-textarea' maxlength='300' length='300' rows='3'></textarea>").prop("id","commentText"+a).data("idx",a)),n.append($("<label for='commentText"+t.data("idx")+"' class='comment-textarea-label'>리플 달기</label>")),e.append(n),t.parent().remove()}}),$(document).on("click",".reply-btn",function(){if(checkLogin()){var t=$(this),e=t.data("idx"),a=t.parent().parent();a.parent().append($("<span><a href='javascript:void(0);' class='comment-re' data-idx='"+e+"'>리플달기</a></span>"));var n=a.parent().find(".comment-box").find(".comment-textarea").val().replace("\r\n"," ").replace("\r"," ").replace("\n"," ");commentAjax("/add.php","url="+location.origin+location.pathname+"&id="+auth.id+"&email="+auth.email+"&comment="+n+"&parent="+e,!0,function(){toastr.success("등록되었습니다."),$("#commentText").val(""),$(".comment-textarea-label").removeClass("active")}),a.remove()}}),$("#createComment").on("click",function(){if(checkLogin()){var t=$("#commentText").val().replace("\r\n"," ").replace("\r"," ").replace("\n"," ");if(""!==$.trim(t))commentAjax("/add.php","url="+location.origin+location.pathname+"&id="+auth.id+"&email="+auth.email+"&comment="+t,!0,function(){toastr.success("등록되었습니다."),$("#commentText").val(""),$(".comment-textarea-label").removeClass("active")});else toastr.error("댓글 내용을 입력해 주시기 바랍니다.")}})});